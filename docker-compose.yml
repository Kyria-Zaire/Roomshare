version: "3.8"

services:
  # ─── Nginx (Reverse Proxy) ───────────────────────────────
  nginx:
    image: nginx:alpine
    container_name: roomshare-nginx
    ports:
      - "80:80"
    volumes:
      - ./backend:/var/www/html
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - php
      - frontend
      - reverb
    networks:
      - roomshare

  # ─── PHP-FPM (Laravel API) ──────────────────────────────
  php:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: roomshare-php
    volumes:
      - ./backend:/var/www/html
    environment:
      - DB_CONNECTION=mongodb
      - DB_HOST=mongodb
      - DB_PORT=27017
      - DB_DATABASE=roomshare
      - BROADCAST_CONNECTION=reverb
      - REVERB_HOST=reverb
      - REVERB_PORT=8080
      - REVERB_SCHEME=http
      - REVERB_APP_ID=roomshare
      - REVERB_APP_KEY=roomshare-key
      - REVERB_APP_SECRET=roomshare-secret
    depends_on:
      - mongodb
    networks:
      - roomshare

  # ─── Laravel Reverb (WebSocket Server) ──────────────────
  # Port 8080 exposé sur l'hôte pour que le navigateur (Windows) puisse s'y connecter.
  reverb:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: roomshare-reverb
    restart: unless-stopped
    command: /var/www/html/docker-entrypoint.sh php artisan reverb:start --host=0.0.0.0 --port=8080
    ports:
      - "8080:8080"
    volumes:
      - ./backend:/var/www/html
    environment:
      - DB_CONNECTION=mongodb
      - DB_HOST=mongodb
      - DB_PORT=27017
      - DB_DATABASE=roomshare
      - BROADCAST_CONNECTION=reverb
      - REVERB_HOST=0.0.0.0
      - REVERB_PORT=8080
      - REVERB_SCHEME=http
      - REVERB_APP_ID=roomshare
      - REVERB_APP_KEY=roomshare-key
      - REVERB_APP_SECRET=roomshare-secret
      - REVERB_SERVER_HOST=0.0.0.0
      - REVERB_SERVER_PORT=8080
    depends_on:
      - mongodb
    networks:
      - roomshare

  # ─── Next.js (Frontend PWA) ─────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: roomshare-frontend
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
    # Port non expose directement, Nginx fait le proxy
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost/api/v1
      - NEXT_PUBLIC_REVERB_HOST=localhost
      - NEXT_PUBLIC_REVERB_PORT=8080
      - NEXT_PUBLIC_REVERB_SCHEME=http
      - NEXT_PUBLIC_REVERB_KEY=roomshare-key
    command: npm run dev
    networks:
      - roomshare

  # ─── MongoDB ─────────────────────────────────────────────
  mongodb:
    image: mongo:7
    container_name: roomshare-mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - roomshare

volumes:
  mongodb_data:

networks:
  roomshare:
    driver: bridge
